 {% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodeZone message</title>
    
    <!-- Font Awesome 6 Free -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha512-...HASH..." crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #e5ddd5;
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100%;
            max-width: 800px;
            margin: auto;
            border: 1px solid #ccc;
            background: #ffffff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .chat-header {
            background: #075e54;
            color: white;
            padding: 10px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid #ccc;
        }

        .chat-header h1 {
            font-size: 18px;
            margin: 0;
            flex: 1;
        }

        .chat-header button {
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 16px;
        }

        .chat-box {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            background: #e5ddd5;
        }

        .input-area {
            display: flex;
            align-items: center;
            padding: 10px;
            border-top: 1px solid #ccc;
            background: #ffffff;
        }

        .input-area input[type="text"] {
            flex: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-right: 10px;
        }

        .input-area .file-icon, .input-area .send-icon, .input-area .record-icon {
            background: #075e54;
            color: white;
            border: none;
            border-radius: 50%;
            padding: 10px;
            cursor: pointer;
            margin-left: 5px;
            font-size: 16px;
        }

        .input-area .file-icon:hover, .input-area .send-icon:hover, .input-area .record-icon:hover {
            background: #054b43;
        }

        .preview-area {
            padding: 10px;
            border-top: 1px solid #ccc;
            background: #e5ddd5;
        }

        .preview-area img, .preview-area video, .preview-area audio {
            max-width: 50%;
            margin-top: 5px;
        }

      
.message img, .message video, .message audio{
    width: 250px;
    max-height: 3body {
            
    }00px;
}
      .message {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    margin-bottom: 12px;
    padding: 10px;
    border-radius: 12px;
    background-color: #f1f1f1;
    max-width: 80%;
    word-wrap: break-word;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

/* avatar rond avec taille uniforme */
.message .avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
}

/* zone de contenu du message */
.message-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: white;
    border-radius: 8px;
    padding: 8px 12px;
    box-shadow: inset 0 0 0 1px #ddd;
}

/* contenu du texte */
.message-content p {
    margin: 0 0 5px;
    line-height: 1.5;
    white-space: pre-wrap;
}

/* heure du message */
.message-time {
    font-size: 0.75rem;
    color: #888;
    text-align: right;
    margin-top: 4px;
}

/* mise en forme des liens */
.message-content a {
    color: #007bff;
    text-decoration: underline;
    word-break: break-all;
}

/* code inline */
.message-content code {
    background-color: #eee;
    padding: 2px 4px;
    border-radius: 4px;
    font-family: monospace;
    font-size: 0.95em;
}

/* blocs de code */
.message-content pre {
    background-color: #272822;
    color: #f8f8f2;
    padding: 10px;
    border-radius: 8px;
    overflow-x: auto;
    font-size: 0.9em;
    margin: 5px 0;
}
        .audio-lobby {
            padding: 10px;
            border-top: 1px solid #ccc;
            background: #ffffff;
        }

        .audio-lobby h2 {
            margin-top: 0;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            padding-top: 60px;
        }

        .modal-content {
            background-color: #ffffff;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #ccc;
            width: 80%;
            border-radius: 8px;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        .file-preview {
            margin-top: 5px;
        }
   @keyframes flash {
    0% { background-color: #e0ffe0; }
    100% { background-color: transparent; }
}

.flash {
    animation: flash 1s ease;
}

.preview-container {
    position: relative;
    margin-bottom: 10px;
    padding: 5px;
    border-radius: 10px;
    background: #e1f3fb;
    display: inline-block;
}

.download-icon {
    position: absolute;
    bottom: 5px;
    right: 5px;
    background: white;
    border: none;
    border-radius: 50%;
    padding: 5px;
    cursor: pointer;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

audio, video {
    border-radius: 10px;
    background: #f0f0f0;
}

.chat-image {
    max-width: 200px;
    border-radius: 8px;
    margin-top: 5px;
}

.chat-video {
    width: 100%;
    max-width: 300px;
    border-radius: 8px;
    margin-top: 5px;
}

.file-message {
    display: flex;
    align-items: center;
    gap: 8px;
}

.download-icon i {
    font-size: 20px;
    color: #007bff;
    cursor: pointer;
}

.loading-spinner {
    width: 10px;
    height: 10px;
    border: 2px solid #ccc;
    border-top: 2px solid #007bff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.audio-message audio {
    width: 100%;
    max-width: 250px;
}

    </style>
</head>
<body>
    <div class="chat-container">
    <div class="chat-header">
        <h1>{{ room_details.name }}</h1>
        <button id="group-settings">‚öôÔ∏è</button>
    </div>

    <div class="chat-box" id="chat-box">
        <!-- Messages ici -->
    </div>

    <div class="input-area">
        <label for="file-input" class="file-icon">üìé</label>
        <input type="file" id="file-input" style="display:none;">
        <input type="text" id="message-input" placeholder="Tapez un message...">
        <button id="send-button" class="send-icon">‚û§</button>
        <button id="record-button" class="record-icon">üé§</button>
    </div>

    <div id="preview-area" class="preview-area"></div>
    <audio id="notificationSound" src="{% static 'sounds/notification.mp3' %}" preload="auto"></audio>
</div>
<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');
</script>

<script>
const chatBox = document.getElementById('chat-box');
const messageInput = document.getElementById('message-input');
const sendButton = document.getElementById('send-button');
const fileInput = document.getElementById('file-input');
const recordButton = document.getElementById('record-button');
const previewArea = document.getElementById('preview-area');
const notificationSound = document.getElementById('notification-sound');

const roomName = "{{ room }}";
const roomId = "{{ room_details.id }}";
const username = "{{ request.user.username }}";

let mediaRecorder;
let chunks = [];

document.addEventListener('DOMContentLoaded', () => {
    if ("Notification" in window && Notification.permission !== "granted") {
        Notification.requestPermission();
    }

    sendButton.addEventListener('click', sendMessage);
    messageInput.addEventListener('keypress', e => {
        if (e.key === 'Enter') sendMessage();
    });

    fileInput.addEventListener('change', () => {
        previewArea.innerHTML = '';
        const file = fileInput.files[0];
        if (!file) return;

        const url = URL.createObjectURL(file);
        const div = document.createElement('div');
        div.classList.add('preview-container');

        const downloadIcon = document.createElement('button');
        downloadIcon.innerHTML = '‚¨áÔ∏è';
        downloadIcon.classList.add('download-icon');
        downloadIcon.addEventListener('click', async () => {
            downloadIcon.textContent = '‚è≥';
            await downloadFile(url, file.name);
            downloadIcon.textContent = '‚¨áÔ∏è';
        });

        if (file.type.startsWith('image/')) {
            div.innerHTML = `<img src="${url}" style="max-width:200px;">`;
        } else if (file.type.startsWith('video/')) {
            div.innerHTML = `
                <video src="${url}" style="max-width:200px;" controls controlsList="nodownload"></video>
            `;
        } else if (file.type.startsWith('audio/')) {
            div.innerHTML = `
                <audio src="${url}" controls controlsList="nodownload" style="width:200px;"></audio>
            `;
        } else {
            div.innerHTML = `<span>${file.name}</span>`;
        }

        div.appendChild(downloadIcon);
        previewArea.appendChild(div);
    });

    recordButton.addEventListener('click', () => {
        if (!mediaRecorder || mediaRecorder.state === 'inactive') {
            navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.start();
                recordButton.textContent = '‚óºÔ∏è';

                mediaRecorder.ondataavailable = e => chunks.push(e.data);
                mediaRecorder.onstop = () => {
                    const blob = new Blob(chunks, { type: 'audio/webm' });
                    chunks = [];
                    const file = new File([blob], `voice_${Date.now()}.webm`, { type: 'audio/webm' });
                    sendVoice(file);
                    recordButton.textContent = 'üé§';
                };
            });
        } else if (mediaRecorder.state === 'recording') {
            mediaRecorder.stop();
        }
    });

    fetchMessages();
    setInterval(fetchMessages, 3000);
});

async function downloadFile(url, filename) {
    const response = await fetch(url);
    const blob = await response.blob();
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
}


function sendMessage() {
    const message = messageInput.value.trim();
    const file = fileInput.files[0];
    if (!message && !file) return;

    const formData = new FormData();
formData.append('room_id', roomId);
formData.append('message', message);
if (file) formData.append('file', file);

    fetch('/send/', {
    method: 'POST',
    headers: {
        'X-CSRFToken': csrftoken
    },
    body: formData
})
    .then(res => res.json())
    .then(data => {
        if (data.status === 'Message envoy√©') {
            messageInput.value = '';
            fileInput.value = '';
            previewArea.innerHTML = '';
            fetchMessages();
        }
    })
    .catch(err => {
        console.error('Erreur envoi :', err);
        alert("Erreur lors de l'envoi du message.");
    });
}


function sendVoice(file) {
    const formData = new FormData();
    formData.append('username', username);
    formData.append('room_id', roomId);
    formData.append('file', file);

    fetch('/send/', {
    method: 'POST',
    headers: {
        'X-CSRFToken': csrftoken
    },
    body: formData
}).then(() => fetchMessages());
}

if ("Notification" in window && Notification.permission !== "granted") {
    Notification.requestPermission();
}

let lastMessageCount = 0;

function fetchMessages() {
    fetch(`/getMessages/${roomName}/`)
        .then(response => response.json())
        .then(data => {
            if (data.messages.length === lastMessageCount) return; // Pas de nouveau message
            lastMessageCount = data.messages.length;

            const wasAtBottom = chatBox.scrollTop + chatBox.clientHeight >= chatBox.scrollHeight - 20;
            chatBox.innerHTML = '';

            data.messages.forEach(msg => {
                const type = msg.file_url ? getFileType(msg.file_name) : 'text';
                const content = msg.file_url
                    ? { type: type, url: msg.file_url, name: msg.file_name }
                    : msg.value;
                addMessageToChat(msg.user, content, type, msg.date);
            });

            if (wasAtBottom) chatBox.scrollTop = chatBox.scrollHeight;
        })
        .catch(error => {
            console.error("Erreur lors de la r√©cup√©ration des messages :", error);
        });
}

function formatMessageText(text) {
    // blocs ```lang
    text = text.replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang, code) => {
        lang = lang || 'plaintext';
        return `<pre><code class="language-${lang}">${escapeHtml(code)}</code></pre>`;
    });

    // blocs indent√©s (4 espaces ou tab)
    text = text.replace(/^( {4}|\t)(.*(?:\n\1.*)*)/gm, (match) => {
        const code = match.replace(/^( {4}|\t)/gm, '');
        return `<pre><code class="language-plaintext">${escapeHtml(code)}</code></pre>`;
    });

    // inline code `code`
    text = text.replace(/`([^`]+)`/g, (_, code) => {
        return `<code>${escapeHtml(code)}</code>`;
    });

    // liens
    text = text.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">$1</a>');

    // retour √† la ligne
    return text.replace(/\n/g, '<br>');
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}


function flashChatBox() {
    chatBox.classList.add('flash');
    setTimeout(() => chatBox.classList.remove('flash'), 1000);
}


function addMessageToChat(sender, content, type, date) {
    const msg = document.createElement('div');
    msg.className = 'message';
    const time = new Date(date).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    const avatar = `https://ui-avatars.com/api/?name=${encodeURIComponent(sender.charAt(0))}&background=random&color=fff&size=40`;

    let filePreview = '';
    if (type !== 'text') {
        filePreview = getFilePreview(content);
        content = '';
    } else {
        content = formatMessageText(content);
    }

    msg.innerHTML = `
        <img src="${avatar}" class="avatar" alt="${sender}">
        <div class="message-content">
            <p><strong>${sender}:</strong> ${content}</p>
            ${filePreview}
            <div class="message-time">${time}</div>
        </div>
    `;

    chatBox.appendChild(msg);

    // Activer la coloration syntaxique si bloc de code d√©tect√©
    msg.querySelectorAll('pre code').forEach((block) => {
        hljs.highlightElement(block);
    });
}


function getFileType(filename) {
    const ext = filename.split('.').pop().toLowerCase();
    if (['jpg', 'jpeg', 'png', 'gif'].includes(ext)) return 'image/';
    if (['mp4', 'webm'].includes(ext)) return 'video/';
    if (['mp3', 'wav'].includes(ext)) return 'audio/';
    return 'file/';
}

function getFilePreview(file) {
    const safeUrl = encodeURI(file.url); // pour √©viter les probl√®mes avec les caract√®res sp√©ciaux
    const fileName = file.name || 'fichier';

    if (file.type.startsWith('image/')) {
        return `
            <img src="${safeUrl}" alt="Aper√ßu de l'image" class="file-preview" style="max-width:200px;">
            <div style="margin-top:10px;">
                <a href="${safeUrl}" download="${fileName}" title="T√©l√©charger">
                    <i class="fas fa-download"></i> T√©l√©charger
                </a>
            </div>
        `;
    }

    if (file.type.startsWith('video/')) {
        return `
            <video controls src="${safeUrl}" style="max-width:200px;"></video>
            <div style="margin-top:10px;">
                <a href="${safeUrl}" download="${fileName}" title="T√©l√©charger la vid√©o">
                    <i class="fas fa-download"></i> T√©l√©charger
                </a>
            </div>
        `;
    }

    if (file.type.startsWith('audio/')) {
        return `
            <audio controls src="${safeUrl}"></audio>
            <div style="margin-top:10px;">
                <a href="${safeUrl}" download="${fileName}" title="T√©l√©charger l'audio">
                    <i class="fas fa-download"></i> T√©l√©charger
                </a>
            </div>
        `;
    }

    return `
        <i class="fas fa-file"></i>
        <a href="${safeUrl}" download="${fileName}" title="T√©l√©charger le fichier">
            ${fileName}
        </a>
    `;
}

</script>
</body>
</html>
